# Using WPS with TerriaJS

- [Call WPS from Terria](#Call-WPS-from-Terria)
- [Output formats](#Output-formats)
- [Terria catalog](#terria-catalog)

For TerriaJS docs and links, see https://docs-v8.terria.io/guide/.

## Call WPS from Terria

Terria maps can connect to external web services. Go to:

1. Explore map data > My data > Add web data
1. Select File type `Web Processing Service (WPS) Server`
1. Enter the WPS server URL

Terria will call `GetCapabilities` and list the available functions.

When a function is selected, Terria will call `DescribeProcess` and populate a form with known input boxes: For example, select a polygon for spatial inputs and select a date/time for temporal inputs.

Complete the input fields and select "Run" process. This will call Execute with the given parameters. Terria will communicate with the WPS service (status and progress updates) until the request is resolved with either a return response (data or picture) or an error.

> See [Geoglam Rapp Help: Analysis tools](https://eo-data.csiro.au/remotesensing/rapp-help/analysis-tools/) for a walk-through example.

If the WPS return response has `mimeType="application/vnd.terriajs.catalog-member+json"` then a catalog item is created for the WPS query and response.

If the return response contains:

- A [correctly formatted](https://github.com/TerriaJS/RaPPMap/issues/133#issuecomment-1498523637) JSON block with CSV time series data then Terria will create a time series line plot.
- A link to a PDF or image file then Terria will render the file in a pop-up window.

## Output formats

WPS can serve outputs back to Terria in a combination of formats. The output format(s) depends on the `Execute` XML generated by Terria when sending the request.

- Static timeseries images 
- Dynamic timeseries with adjustable date ranges
- Table data rendered in browser
- A link to a downloadable CSV

In a Curl `Execute` request with a custom XML file multiple output formats can be specified within a ProcessOutputs tag:

```xml
<ProcessOutputs>
    <Output>
        <ows:Identifier>download_link</ows:Identifier>
        <ows:Title>CSV Download Link</ows:Title>
        <ows:Abstract/>
        <LiteralOutput>
            <ows:DataType ows:reference="http://www.w3.org/TR/xmlschema-2/#string">string</ows:DataType>
        </LiteralOutput>
    </Output>
    <Output>
        <ows:Identifier>csv</ows:Identifier>
        <ows:Title>CSV Results</ows:Title>
        <ows:Abstract/>
        <ComplexOutput>
            <Default>
                <Format>
                    <MimeType>application/vnd.terriajs.catalog-member+json</MimeType>
                    <Schema>https://tools.ietf.org/html/rfc7159</Schema>
                </Format>
            </Default>
            <Supported>
                <Format>
                    <MimeType>application/vnd.terriajs.catalog-member+json</MimeType>
                    <Schema>https://tools.ietf.org/html/rfc7159</Schema>
                </Format>
                <Format>
                    <MimeType>text/csv</MimeType>
                    <Schema/>
                </Format>
            </Supported>
        </ComplexOutput>
    </Output>
</ProcessOutputs>
```

Or a ResponseForm tag:

```xml
<wps:ResponseForm>
    <wps:RawDataOutput mimeType="application/vnd.terriajs.catalog-member+json">
      <ows:Identifier>timeseries</ows:Identifier>
    </wps:RawDataOutput>
  </wps:ResponseForm>
```

## Terria catalog

Example Terria catalog items for the WPS processes.

Notes:

- `"storeSupported": true`
   - A path to a downloadable file can be returned to Terria
- `"statusSupported": true`
   - Terria can poll the service for progress updates
- `"forceConvertResultsToV8": true`
   - Older v7 return data structures can be converted to the v8 data structure (see [example](https://github.com/TerriaJS/RaPPMap/issues/133#issuecomment-1498523637)).

Typically added to the Terria server's `wwwroot/init/simple.json` (or similar):
```json
{
  "homeCamera": {
    "north": -8,
    "east": 158,
    "south": -45,
    "west": 109
  },
  "catalog": [
    {
      "id": "Mangrove Cover Drill",
      "type": "wps",
      "storeSupported": true,
      "statusSupported": true,
      "url": "http://localhost:8000/?service=WPS",
      "identifier": "Mangrove Cover Drill",
    },
    {
      "id": "Water Observations From Space Drill",
      "type": "wps",
      "storeSupported": true,
      "statusSupported": true,
      "url":"https://wps.dev.easi-eo.solutions/?service=WPS",
      "identifier": "WOfSDrill",
    },
    {
      "id": "Fractional Cover Drill",
      "type": "wps",
      "storeSupported": true,
      "statusSupported": true,
      "url":"https://wps.dev.easi-eo.solutions/?service=WPS",
      "identifier": "FractionalCoverDrill",
    },
    {
      "id": "WIT Polygon Drill",
      "type": "wps",
      "storeSupported": true,
      "statusSupported": true,
      "url":"https://wps.dev.easi-eo.solutions/?service=WPS",
      "identifier": "WIT",
    }
  ],
  "viewerMode": "3dSmooth",
  "baseMaps": {
    "defaultBaseMapId": "basemap-positron",
    "previewBaseMapId": "basemap-positron"
  },
  "corsDomains": [ 
    "localhost:8000",
    "localhost:5000",
    "https://s3.ap-southeast-2.amazonaws.com",
    "s3.ap-southeast-2.amazonaws.com"
  ]
}
```